## Atualiza√ß√£o Backend ‚Äì 19/11/2025

### Contexto
Consolidamos o suporte RAG dos agentes EmployeeVirtual, criando o fluxo completo para upload de PDFs, persist√™ncia no MongoDB, integra√ß√£o com Pinecone e execu√ß√£o via PydanticAI. Este documento serve como refer√™ncia r√°pida para a squad ‚Äì especialmente para o Henrique (frontend) que consumir√° as novas rotas ao integrar o upload e execu√ß√£o RAG no app.

### Principais Mudan√ßas
- **Upload vetorial dos agentes** (`POST /api/agents/{agent_id}/documents`)
  - Aceita `filepdf` (bin√°rio do PDF) e campo opcional `metadone` com JSON.
  - Encaminha o arquivo para `https://app-vectordb-ia.azurewebsites.net/upsert/upsert-pdf/metadonnes`.
  - Registra cada upload em `Collections.AGENT_DOCUMENTS` (*MongoDB*), guardando metadados e payload retornado pelo servi√ßo vetorial.
- **Execu√ß√£o RAG**
  - `AIService` agora inicializa o `RagAgentRunner` (OpenAI + Pinecone) quando `PINECONE_*` estiverem configurados.
  - `AgentService.execute_agent` detecta se o agente possui documentos e utiliza o fluxo RAG (tool `retrieve` com Pinecone + embeddings) antes de responder.
  - Fallback autom√°tico mant√©m o comportamento anterior quando n√£o h√° corpus ou chaves de Pinecone.
- **Cliente Pinecone**
  - Criado `VectorDBClient` para uploads multipart.
  - Criado `RagAgentRunner` com tool `retrieve` que consulta o √≠ndice Pinecone filtrando por `agent_id`.

### Novas Vari√°veis de Ambiente
| Vari√°vel | Descri√ß√£o | Default |
|----------|-----------|---------|
| `VECTOR_DB_BASE_URL` | Endpoint do microservi√ßo que recebe PDFs (atuamente `https://app-vectordb-ia.azurewebsites.net`) | `https://app-vectordb-ia.azurewebsites.net` |
| `PINECONE_API_KEY` | API key Pinecone utilizada pelo `RagAgentRunner` | _None_ |
| `PINECONE_INDEX_NAME` | Nome do √≠ndice Pinecone (ex.: `employeevirtual-agents`) | _None_ |
| `PINECONE_CLOUD` | Cloud provider do √≠ndice serverless (`aws`, `gcp`, etc.) | `aws` |
| `PINECONE_REGION` | Regi√£o do √≠ndice serverless | `us-east-1` |

> **Importante**: certifique-se de definir `OPENAI_API_KEY`, `PINECONE_API_KEY` e `PINECONE_INDEX_NAME` no `.env` para que o RAG seja habilitado. Sem esses valores o sistema volta automaticamente ao modo ‚Äún√£o-RAG‚Äù.

### Para o Henrique (Frontend)
- Consumir a nova rota `POST /api/agents/{agent_id}/documents` enviando:
  - `filepdf`: arquivo `multipart/form-data`.
  - `metadone`: string JSON com metadados extras para enriquecer a busca (ex.: `{"curso":"IA","modulo":"1"}`).
- Ap√≥s o upload, o backend retornar√° o registro salvo no Mongo (`document`) e a resposta do microservi√ßo vetorial (`vector_db_response`). Use esse retorno para exibir status e permitir gerenciamento de documentos.
- Durante a execu√ß√£o do chat/agente, exibir indica√ß√£o visual quando o backend responder com contexto RAG (opcional, mas ajuda usu√°rios a entenderem que o conhecimento vem do PDF).

### Pr√≥ximos Passos Recomendados
1. **Frontend** (Henrique):
   - Ajustar o formul√°rio de cria√ß√£o/edi√ß√£o de agente para permitir upload de PDFs e metadados.
   - Garantir tratamento de erros 400/502 vindos do backend (ex.: metadados inv√°lidos ou falha no servi√ßo vetorial).
2. **Backend**:
   - (Opcional) Expor endpoints para listar/remover documentos (`AgentDocumentRepository.list_documents/delete_document`) se o frontend precisar.
   - Implementar job de limpeza/reprocessamento caso o √≠ndice Pinecone necessite de versionamento.
3. **Infra**:
   - Provisionar o √≠ndice Pinecone com `dimension=1536` (modelo `text-embedding-3-small`) e validar lat√™ncia no ambiente alvo.

Com isso o EmployeeVirtual passa a suportar agentes verdadeiramente contextuais, e o Henrique j√° pode seguir com a integra√ß√£o no frontend. Qualquer d√∫vida adicional √© s√≥ pingar! üöÄ

